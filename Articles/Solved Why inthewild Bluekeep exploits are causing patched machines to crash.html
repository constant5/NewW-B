<figure class="intro-image intro-left">
  <img src="https://cdn.arstechnica.net/wp-content/uploads/2019/11/bsod-800x534.jpg" alt="Solved: Why in-the-wild Bluekeep exploits are causing patched machines to crash"/>
      <p class="caption" style="font-size:0.8em"><a href="https://cdn.arstechnica.net/wp-content/uploads/2019/11/bsod.jpg" class="enlarge-link" data-height="683" data-width="1024">Enlarge</a> (credit: <a rel="nofollow" class="caption-link" href="https://www.flickr.com/photos/hdaniel/8204600452">hdaniel</a>)</p>  </figure>






<div><a name='page-1'></a></div>
<p>Recent in-the-wild attacks on the <a href="https://arstechnica.com/information-technology/2019/05/microsoft-warns-wormable-windows-bug-could-lead-to-another-wannacry/">critical Bluekeep vulnerability in many versions of Windows</a> arenâ€™t just affecting unpatched machines. It turns out the exploitsâ€”which repurpose the <a href="https://arstechnica.com/information-technology/2019/09/exploit-for-wormable-bluekeep-windows-bug-released-into-the-wild/">September release from the Metasploit framework</a>â€”are also causing many patched machines to crash.</p>
<p>Late last week, Windows users learned why: a <a href="https://msrc-blog.microsoft.com/2018/03/23/kva-shadow-mitigating-meltdown-on-windows/">separate patch Microsoft released 20 months ago</a> for the <a href="https://arstechnica.com/gadgets/2018/01/meltdown-and-spectre-every-modern-processor-has-unfixable-security-flaws/">Meltdown vulnerability in Intel CPUs</a>. Word of the crashes first emerged five days ago, when researcher Kevin Beaumont discovered a malicious, in-the-wild Bluekeep exploit <a href="https://twitter.com/GossiTheDog/status/1191642063315623937">caused one of his honeypots to crash four times overnight</a>. Metasploit developer Sean Dillon initially blamed the crashes on â€œmystical reptilian forces that control everything.â€ Then he read a <a href="https://twitter.com/sleepya_/status/1191239163959373824">Twitter post</a> from researcher Worawit Wang:</p>
<blockquote class="twitter-tweet">
<p dir="ltr" lang="en">From call stack, seems target has kva shadow patch. Original eternalblue kernel shellcode cannot be used on kva shadow patch target. So the exploit failed while running kernel shellcode</p>
<p>â€” Worawit Wang (@sleepya_) <a href="https://twitter.com/sleepya_/status/1191239163959373824?ref_src=twsrc%5Etfw">November 4, 2019</a></p></blockquote>
<p>In a <a href="https://zerosum0x0.blogspot.com/2019/11/fixing-remote-windows-kernel-payloads-meltdown.html">post published on Thursday</a>, Dillon wrote:</p>
<blockquote><p>Turns out my BlueKeep development labs didn't have the Meltdown patch, yet out in the wild it's probably the most common case.</p>
<p>tl;dr: Side effects of the Meltdown patch inadvertently breaks the syscall hooking kernel payloads used in exploits such as EternalBlue and BlueKeep. Here is a horribly hacky way to get around it... but: it pops system shells so you can run Mimikatz, and after all isn't that what it's all about?</p></blockquote>
<h2>Recursive loop</h2>
<p>Dillonâ€™s post offers a deep-dive explanation for why his exploit didnâ€™t work on machines that installed the Meltdown patch, which Microsoft called KVA Shadow, short for Kernel Virtual Address Shadow. In short, the mitigation worked by isolating virtual memory page tables of user-mode threads from kernel memory. The exception is a small subset of kernel code and structures, which must be exposed enough to swap kernel page tables when carrying out trap exceptions, syscalls, and similar functions. The shellcode spawned by Dillonâ€™s Bluekeep exploit wasnâ€™t part of the KVA Shadow code, so user mode couldnâ€™t react with the Shadow Code. As a result, the kernel got stuck in a recursive loop until the system finally crashed.</p>
<p>Dillon has since <a href="https://github.com/rapid7/metasploit-framework/pull/12553">rewritten the exploit code</a>. He expects the fix to be integrated into the official Metasploit Bluekeep module soon.</p>
<p>The crashes came to light after attackers started exploiting Bluekeep in an attempt to install cryptocurrency miners on unpatched machines. The exploits donâ€™t spread from computer to computer with no user interaction, and as noted, they also caused many machines to crash, causing many people to discount the potential severity of the Bluekeep vulnerability. Microsoft researchers, however, <a href="https://www.microsoft.com/security/blog/2019/11/07/the-new-cve-2019-0708-rdp-exploit-attacks-explained/">warned last week</a> that they â€œcannot discount enhancements that will likely result in more effective attacks.â€ They also said that â€œthe BlueKeep exploit will likely be used to deliver payloads more impactful and damaging than coin miners.â€</p>
<p>Meanwhile, Marcus Hutchins, the security researcher who also goes by the handle MalwareTech, <a href="https://twitter.com/MalwareTechBlog/status/1192926816370970625">made a compelling caseÂ </a>that Bluekeep exploits have the potential to be severe even if they donâ€™t spread as a worm from computer to computer without user interaction in the way the <a href="https://arstechnica.com/information-technology/2017/05/an-nsa-derived-ransomware-worm-is-shutting-down-computers-worldwide/">WannaCry</a> and <a href="https://arstechnica.com/information-technology/2017/06/petya-outbreak-was-a-chaos-sowing-wiper-not-profit-seeking-ransomware/">NotPetya</a> outbreaks did.</p>
<h2>Internal pivot</h2>
<p>WannaCry and NotPetya exploited the server message block protocol, which was enabled in many desktop computers. Bluekeep, by contrast, exploits Windowsâ€™ Remote Desktop Services, which is usually turned on only on servers.</p>
<p>â€œA worm would not only attract a lot of attention, but be technically challenging due to the limitations of BlueKeep,â€ Hutchins <a href="https://twitter.com/MalwareTechBlog/status/1192926820506554368">wrote</a>. That hardly means Bluekeep doesnâ€™t have the potential to do significant damage. Because servers typically act as domain administrators, network management tools, or share the same local administrator credentials with other network machines, they have the ability to control much of the network.</p>
<p>â€œBy compromising a network server, it is almost always extremely easy to use automated tooling to pivot internally (Ex: have the server drop ransomware to every system on the network),â€ Hutchins <a href="https://twitter.com/MalwareTechBlog/status/1192926822473682944">explained</a>.</p>
<p>Bluekeep affects Windows 7, Windows Server 2008 R2, and Windows Server 2008. Patches for those versions are available <a href="https://portal.msrc.microsoft.com/en-us/security-guidance/advisory/CVE-2019-0708">here</a>. Because of its severity, Microsoft has <a href="https://support.microsoft.com/en-us/help/4500705/customer-guidance-for-cve-2019-0708">made patches available</a> for Windows XP, Vista, and Server 2003, which are no longer supported. People or organizations that have yet to patch should do so as soon as possible.</p>

